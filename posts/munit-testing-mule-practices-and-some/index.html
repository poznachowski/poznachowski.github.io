<!doctype html>
<html lang="en-us">
  <head>
    <title>MUnit testing, Mule best practices and more... // It&#39;s SOAP&#39;s Fault...</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.120.3">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Grzegorz Poznachowski" />
    <meta name="description" content="Best practices on using MUnit Mule ESB testing framework" />
    <script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://blog.poznachowski.pl/css/main.min.d2628e6ba0d9f16b8d64c2324354aac3b4b6815035d0bd0606508586eca3ccf3.css" />
    <link rel="stylesheet" type="text/css" href="https:////fonts.googleapis.com/css?family=Quicksand" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />

    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EN6FNBMMQY"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-EN6FNBMMQY', { 'anonymize_ip': false });
}
</script>

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MUnit testing, Mule best practices and more..."/>
<meta name="twitter:description" content="Best practices on using MUnit Mule ESB testing framework"/>
<meta name="twitter:site" content="@poznachowski"/>

    <meta property="og:title" content="MUnit testing, Mule best practices and more..." />
<meta property="og:description" content="Best practices on using MUnit Mule ESB testing framework" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.poznachowski.pl/posts/munit-testing-mule-practices-and-some/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-04-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2014-04-03T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <div class="flex-wrapper">
        <a href="https://blog.poznachowski.pl/">
          <img class="app-header-avatar" src="/gp.jpg" alt="Grzegorz Poznachowski" />
        </a>
        <div class="flex-text">
          <a href="https://blog.poznachowski.pl/">
            <h1>It&#39;s SOAP&#39;s Fault...</h1>
          </a>
          <p>My notes on coding and software development</p>
        </div>
      </div>
      <div class ="footer-desktop">
        <section class="social">
  
  <a href="https://linkedin.com/in/gpoznachowski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
  
	
	
	<a href="https://github.com/poznachowski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	

	
	<a href="https://stackoverflow.com/users/2514330" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
  
  <a href="https://twitter.com/poznachowski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
  
	
	<a href="mailto:grzegorz@poznachowski.pl" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>
<div class="copyright">
  blog.poznachowski.pl &copy; 2013 - 2023
</div>

      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">MUnit testing, Mule best practices and more...</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          03.04.2014
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          18 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://blog.poznachowski.pl/tags/assertj/">assertj</a><a class="tag" href="https://blog.poznachowski.pl/tags/mock/">mock</a><a class="tag" href="https://blog.poznachowski.pl/tags/munit/">munit</a><a class="tag" href="https://blog.poznachowski.pl/tags/esb/">esb</a><a class="tag" href="https://blog.poznachowski.pl/tags/design/">design</a><a class="tag" href="https://blog.poznachowski.pl/tags/testing/">testing</a><a class="tag" href="https://blog.poznachowski.pl/tags/mule/">mule</a><a class="tag" href="https://blog.poznachowski.pl/tags/flow/">flow</a></div></div>
    </header>
    <div class="post-content">
      <p>Quite long time passed, since my last update. I hope that this post will successfully fill the resulting gap and you will find reading it worthwhile.</p>
<p><strong>Table of Content:</strong></p>
<ol>
<li><a href="#a-little-bit-too-long-of-a-foreword">Foreword</a></li>
<li><a href="#munit-introduction">MUnit introduction</a></li>
<li><a href="#think-about-your-flow-design">Think about your flow design</a></li>
<li><a href="#test-constants">Test constants</a></li>
<li><a href="#assertions">Assertions</a></li>
<li><a href="#munit-test-structure">MUnit test structure</a></li>
<li><a href="#property-enricher">Property enricher</a></li>
<li><a href="#execution-environments">Execution environments</a></li>
<li><a href="#mocking">Mocking</a></li>
<li><a href="#implementing-mocked-services">Implementing mocked services</a></li>
<li><a href="#verifying--spying">Verifying &amp; spying</a></li>
<li><a href="#summary">Summary</a></li>
</ol>
<ul>
<li><a href="https://github.com/poznachowski/munit-utils">munit-utils@github</a></li>
<li><a href="https://dl.dropboxusercontent.com/u/17262593/blog/munit-utils-0.0.1.zip">munit-utils-0.0.1.zip</a></li>
</ul>
<h2 id="a-little-bit-too-long-of-a-foreword">A little bit too long of a foreword&hellip;</h2>
<p>When I first met Mule there was that thing, that made me feel a little bit discouraged. There was only residual information about best practices on how to develop Mule applications and even less advice on how to effectively test them. All Mule examples provided here and there on the Internet are presented in a deploy-click-check if works manner. Next thing is that all demos are mostly simple, one-flow applications. Question about how to cope with larger, complex configurations was left unanswered.
I&rsquo;ll try to shed some light on those subjects. For starters, there is some great writing by Ryan Hoegg available at <a href="http://confluex.com/blog/integration-software-is-software/">Confluex blog</a>. I&rsquo;ll try to elaborate more on some topics brought up by Ryan, but focusing mainly on testing part using MUnit framework.
When talking about testing in Mule environment it is worth to emphasize that two types of tests exist here. Following the Mule documentation naming convention, first type are <a href="http://www.mulesoft.org/documentation/display/current/Unit+Testing">unit tests</a>, which cover your self-written message processors (transformers, components etc.) Mule&rsquo;s current testing capabilities are more than enough to handle those cases pretty well. In terms of testing Groovy script components <a href="/2013/11/03/handling-groovy-scripts-in-mule-esb">here is something</a> I wrote previously.
The other are <a href="http://www.mulesoft.org/documentation/display/current/Functional+Testing">functional tests</a> - our main point of interest for this blog post.
I&rsquo;d like to call them flow tests. Scope of these kinds of tests are pretty wide. How you approach them is up to you. You can test any given part of your application (depending on how you designed and structured your flows):</p>
<ul>
<li>From testing integration between two adjacent message processors</li>
<li>via business logic branches (capable of having mocked out any part of the process - external service calls, connections to DB, sending MQ messages etc.)</li>
<li>to full system testing with all external services calls on board.</li>
</ul>
<p>Obviously, the best is to have mix of those, excluding the latter from your automated build test suite. We don&rsquo;t want to call actual, external services each build, do we? <a href="http://stackoverflow.com/questions/2606572/junit-splitting-integration-test-and-unit-tests">Here</a> is an idea of how you can separate them.</p>
<p>For all that MUnit comes in handy&hellip;</p>
<h2 id="munit-introduction">MUnit introduction</h2>
<p><a href="https://github.com/mulesoft/munit">MUnit</a> is a next generation Mule testing framework. It is still under development, but its current state (3.4-M5) is more than enough to persuade me to use it in my work projects. In fact, I&rsquo;m using it since the first day I discovered it, as the <a href="http://www.mulesoft.org/documentation/display/current/Introduction+to+Testing+Mule">current testing framework</a> lacks flexibility in my opinion.
Plenty of MUnit features are not easily available to the current, official version (i.e. mocking flows and outbound endpoints is cumbersome and requires a lot of effort). What&rsquo;s more, MUnit comes in two flavours:</p>
<ul>
<li>Well-known Java approach, where you write your tests as you would normally do (via JUnit).</li>
<li>Mule XML code with MUnit schema.</li>
</ul>
<p>One thing needs mentioning. This blog post is strictly Java-centric, I won&rsquo;t tell you anything about the XML way of writing MUnit tests. If that was not what you were looking for, I&rsquo;m sorry to disappoint you.
The reason is simple - I&rsquo;m not a fan of XML and the Java approach suits me much better. Nevertheless, everything MUnit can do with XML is possible using Java (and the other way round). That&rsquo;s, at least, what specification states :) (I haven&rsquo;t checked that).</p>
<p>MUnit is getting more recognizable lately (eventually it ought to replace current testing framework). Latest Mule (3.5 Early Access version) starts integrating MUnit with Studio heavily. More information about MUnit capabilities is available at project&rsquo;s <a href="https://github.com/mulesoft/munit/wiki">wiki page</a>, but I&rsquo;ll try to cover most of its powers here.</p>
<h2 id="think-about-your-flow-design">Think about your flow design</h2>
<p>I&rsquo;ll try to outline some guidelines I now follow. They emerged from my  ~year Mule integration experience. Note: I can&rsquo;t guarantee they will solve all your problems nor they will fit each of possible use cases. I&rsquo;m just saying that they helped me survive some of the bad times I had. What&rsquo;s even more important, I&rsquo;m not even sure if they are the best I can get from my cooperation with Mule and Studio. If you have your own practices, questions, suggestions I&rsquo;d like to hear them!</p>
<p>In the beginning I want to emphasize that Mule&rsquo;s code it&rsquo;s even easier to get messy with than with Java (at least for me). Hence, having good test coverage is crucial. How you design your flows implies the ease of testing them. What&rsquo;s more, I really recommend to start your work flow in a TDD manner and let you flow design be guided by tests. From my experience, I can say, it pays off greatly later on.</p>
<p>Keep your flows short, make sure that each flow follows single responsibility principle. For complex solution split your configuration file (.xmls containing flows) into smaller ones. Think in functionality and business logic terms. I&rsquo;m used to having one configuration file with main flow (with source component) controlling the whole process and others implementing bigger chunks of business logic (i.e. sending attachments with gathered information, fulfilling customer data) Of course each of these configuration files can contain many flows / subflows. Mule by <em>mule-deploy.properties</em> file (<em>config.resources</em> attribute) knows, which files comprise whole application set-up.</p>
<p>Let&rsquo;s say we have a requirement to expose a service via HTTP endpoint, which needs to perform some complex validation logic (on HTTP Headers, Request Body etc.), then transform the provided data into a proprietary structure, backing it up with data coming from external REST Service. Eventually send a notification email to anyone who it may concern.
Example configuration can look like this:</p>
<h3 id="main-flowxml">main-flow.xml:</h3>
<p><img src="/images/munit/main-flow.png" alt="main-flow"></p>
<p>This main flow can accommodate whole application process into few single flow references, which can be easily read and understood. Every of the bigger, complex tasks was extracted to a different configuration file. With such structure we can execute end-to-end tests or test only main processing paths of full solution (when flow has choice components as presented) by mocking out all referenced implementations. To not litter the main flow, we extracted variables initialization part to a subflow. Those variables can be then used in processing data or sending email part.</p>
<h3 id="validate-requestxml-process-customer-dataxml-send-email-notificationxml">validate-request.xml, process-customer-data.xml, send-email-notification.xml:</h3>
<p><img src="/images/munit/validate-request.png" alt="">
<img src="/images/munit/process-customer-data.png" alt="">
<img src="/images/munit/send-notification-email.png" alt=""></p>
<p>Each of that configuration files is responsible for different phase of the solution. We can do the same with them if the flows would get bigger: split into more compact flows / subflows or even into another configuration files if necessary.</p>
<p>At some point in time, you may come up with the idea, that part of application should be extracted as separate Mule application. Keeping your flows modularized, makes this task relatively easy.
What&rsquo;s also important (and it&rsquo;s our subject) is that it allows us to test parts of the application in isolation. With MUnit you don&rsquo;t need to have an inbound endpoint to call your flow. In fact, in MUnit you can access any flow directly (it disables all inbounds by default). You can test validation part by running your test against <em>ValidateHTTPRequest</em> flow or check if all variables were initialized properly by calling <em>InitializeVariables</em> subflow from within MUnit test.</p>
<p>Lastly, a word about flow &lsquo;packaging&rsquo;. Unfortunately Studio can&rsquo;t accept the fact that I&rsquo;d like to have my config files structured in subdirectories. The only appropriate place for them, according to Studio, is <em>src/main/app</em>. Whenever you try to put a flow config into a subfolder, Studio recreates it in &lsquo;root&rsquo; directory..</p>
<h2 id="test-constants">Test constants</h2>
<p>You will be using variables in your tests. A lot! Flow names, variable names, configuration files to name a few. Keeping those names as interface constants gives you two advantages:
1. When renaming any variable, you don&rsquo;t have to go through all tests and correct one by one - just rename once in the interface.
2. When you enable your interface class for static imports in Mule Studio, you can type those values in no-time using code completion assistance:</p>
<p><img src="/images/munit/test_constants_code_compl.png" alt="test_constants_code_compl"></p>
<h2 id="assertions">Assertions</h2>
<p>To make sure that flows behave in the way we expect them to, there are two objects we are most interested in checking: <strong>MuleEvent</strong> and <strong>MuleMessage</strong>. These two are main targets for assertion expressions. MuleEvent is a basic entity which MUnit test returns as a result. it contains MuleMessage, attachments and session data.</p>
<p>I&rsquo;m a big fan of fluent assertions, hence I strongly recommend giving them a try. <a href="http://joel-costigliola.github.io/assertj/">AssertJ</a> is the framework to look at. It&rsquo;s a successor of <a href="https://github.com/alexruiz/fest-assert-2.x/wiki">Fest Assert</a>. Constantly under development, has plenty of contributors with a thriving community. Most valuable benefit of using AssertJ is the great number of assertion types and direct support from your IDE (code completion).</p>
<p>To ease work with Mule stuff, I&rsquo;ve created small extension for AssertJ. It is available at my GitHub, <a href="https://github.com/poznachowski/munit-utils">here</a>. Right now it&rsquo;s an early version, bound together with something I call property enricher (I&rsquo;ll cover that later on). It covers presence of Mule Message properties (of different scopes), payload checks etc. Not everything&rsquo;s included, but most common cases I encountered in my projects.
It&rsquo;s not available in any public repository (yet?). You can build it yourself or get jar and sources from <a href="https://dl.dropboxusercontent.com/u/17262593/blog/munit-utils-0.0.1.zip">here</a>, then install them into your local maven repository <a href="http://maven.apache.org/guides/mini/guide-3rd-party-jars-local.html">manually</a> (or preferably into your artefact repository). Then you follow these instructions, common for every other AssertJ extension:</p>
<ol>
<li>Add the library to your project</li>
<li>Enable <strong>pl.poznachowski.mule.message.assertions.Assertions</strong> for static imports</li>
<li>Start using:</li>
</ol>
<p><img src="/images/munit/assertThat.png" alt="assertThat">
<img src="/images/munit/assertThat2.png" alt="assertThat2"></p>
<p>I think there is no need to go into details about available assertions. You can explore them on your own. Just one note here: When making assertions on <em>MuleEvent</em> object, make sure you &rsquo;traverse down&rsquo; to asserting <em>MuleMessage</em> using <strong>hasMuleMessageWhich()</strong> method as the last check for <em>MuleEvent</em>, as you won&rsquo;t be able to go back to it in the same assertion statement.</p>
<h2 id="munit-test-structure">MUnit test structure</h2>
<p>MUnit test does not differ much than the previous functional Mule test. Simplest example is presented below:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> pl.poznachowski.munitblogsamples;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import static</span> pl.poznachowski.mule.message.assertions.Assertions.assertThat;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import static</span> pl.poznachowski.munitblogsamples.TestConstants.VALIDATE_REQUEST_FLOW;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.junit.Test;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.mule.api.MuleEvent;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.mule.munit.runner.functional.FunctionalMunitSuite;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">FirstMunitTest</span> <span style="color:#8be9fd;font-style:italic">extends</span> FunctionalMunitSuite {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> @Test
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">simplestTest</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>  MuleEvent result <span style="color:#ff79c6">=</span> runFlow(VALIDATE_REQUEST_FLOW, testEvent(<span style="color:#f1fa8c">&#34;payload&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  assertThat(result)
</span></span><span style="display:flex;"><span>   .<span style="color:#50fa7b">hasMuleMessageWhich</span>()
</span></span><span style="display:flex;"><span>     .<span style="color:#50fa7b">hasStringPayload</span>(<span style="color:#f1fa8c">&#34;payload&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, it&rsquo;s an ordinary JUnit test extending FunctionalMunitSuite class.
There are two thing we need to do in our test:</p>
<ol>
<li>Prepare <strong>MuleEvent</strong> object as an input to our flow. We can do that by using provided <strong>testEvent(Object payload)</strong> method.</li>
<li>Execute <strong>runFlow(String flowName, MuleEvent event)</strong> method specifying flow name to test against and event we just created in the first step.</li>
</ol>
<p>Of course, to make our test sensible, we need to assert whether the expected result is equal to what the flow actually produced as an output.</p>
<p>MUnit, by default, scans your <em>mule-deploy.properties</em> file and load all configuration files it can find there to perform the test. It&rsquo;s rarely the case we&rsquo;d like to have (except end-to-end testing). Main reason for avoiding that, is speed. We our tests to perform as fast as possible and there is no reason to include whole configuration when we are testing (i.e.) validation logic only. To accomplish that we need to override <strong><em>getConfigResources()</em></strong> method and provide configuration files, which should participate in a test:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">FirstMunitTest</span> <span style="color:#8be9fd;font-style:italic">extends</span> FunctionalMunitSuite {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> @Override
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd;font-style:italic">protected</span> String <span style="color:#50fa7b">getConfigResources</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> Joiner.<span style="color:#50fa7b">on</span>(<span style="color:#f1fa8c">&#39;,&#39;</span>).<span style="color:#50fa7b">join</span>(MAIN_FLOW_CFG, VALIDATE_REQUEST_CFG);
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>This method accepts String value with comma separated config file names. To produce such String I use Guava&rsquo;s Joiner class. All configuration files names should, of course :), be set up as interface constants (i.e. MAIN_FLOW_CFG = &ldquo;main-flow.xml&rdquo;)</p>
<p>Another thing we need to know about MUnit is, that all inbound endpoints are skipped by default, meaning the process begin just right after when it would be intercepted by the source endpoint. However, it is still possible to use an inbound entry point for accessing flow in a test. There are two ways to achieve that:</p>
<ul>
<li>Override <strong><a href="https://github.com/mulesoft/munit/blob/munit-3.4.x/munit-core/munit-runner/src/main/java/org/mule/munit/runner/functional/FunctionalMunitSuite.java#L107">haveToDisableInboundEndpoints()</a></strong> method and make it return <strong>false</strong>, or you can selectively pick flows which won&rsquo;t have inbound endpoints disabled by:</li>
<li>Overriding <strong><a href="https://github.com/mulesoft/munit/blob/munit-3.4.x/munit-core/munit-runner/src/main/java/org/mule/munit/runner/functional/FunctionalMunitSuite.java#L89"><!-- raw HTML omitted -->getFlowsExcludedOfInbound<!-- raw HTML omitted -->Disabling()</a></strong> method and providing list of String values with flows to exclude.</li>
</ul>
<p>If you enabled your inbound endpoints, then you can access your flows in the old way. Only thing you need to do is to obtain <strong>MuleClient</strong> from <strong>muleContext</strong>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>MuleClient client <span style="color:#ff79c6">=</span> muleContext.<span style="color:#50fa7b">getClient</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><p>and use the client instead of <strong>runFlow()</strong> method.</p>
<p>When working with custom connectors and mocking them out is not a desired behavior, there is a method you can use: <a href="https://github.com/mulesoft/munit/blob/munit-3.4.x/munit-core/munit-runner/src/main/java/org/mule/munit/runner/functional/FunctionalMunitSuite.java#L127"><strong>haveToMockMuleConnectors()</strong></a>. In that case, we want to override it and return false.
In terms of packaging, I&rsquo;m used to keeping my Mule tests in packages named after flow names (then subpackage them if necessary), i.e. <em>pl.poznachowski.munit.example.mainflow</em></p>
<h2 id="property-enricher">Property enricher</h2>
<p>Properties are most widely used features of Mule. Hence, it won&rsquo;t be uncommon to test part of application with <em>MuleMessage</em> already containing some Mule properties or to mock a message processor to modify them (alter / create / remove).
When creating <em>MuleEvent</em> for testing purposes you only can set payload using provided <strong>testEvent()</strong> method. To make working with properties easier I&rsquo;ve introduced something I call property enricher. You can fluently apply any kind of property on either <strong>MuleEvent</strong> object or <strong>MuleMessage</strong>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">simplestTest</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  MuleEvent testEvent <span style="color:#ff79c6">=</span> PropertyEnricher.<span style="color:#50fa7b">enrich</span>(testEvent(<span style="color:#f1fa8c">&#34;payload&#34;</span>))
</span></span><span style="display:flex;"><span>       .<span style="color:#50fa7b">withInvocationProperty</span>(SOME_VARIABLE, <span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>       .<span style="color:#50fa7b">get</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  MuleEvent result <span style="color:#ff79c6">=</span> runFlow(VALIDATE_REQUEST_FLOW, testEvent);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  assertThat(result)
</span></span><span style="display:flex;"><span>   .<span style="color:#50fa7b">hasMuleMessageWhich</span>()
</span></span><span style="display:flex;"><span>   .<span style="color:#50fa7b">hasStringPayload</span>(<span style="color:#f1fa8c">&#34;payload&#34;</span>)
</span></span><span style="display:flex;"><span>   .<span style="color:#50fa7b">hasInvocationProperty</span>(SOME_VARIABLE).<span style="color:#50fa7b">withValue</span>(<span style="color:#ff79c6">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you&rsquo;d like to give it a try, it&rsquo;s a part of the same utility project I described before - available <a href="https://github.com/poznachowski/munit-utils">here</a>.</p>
<h2 id="execution-environments">Execution environments</h2>
<p>I think it is always a good idea to parametrize any properties eligible to change between execution environments. This has been well explained in the Confluex blog post. Having prepared beforehand property files for each environment and then not to worry about it during deployment is something I really appreciate. But what if we want to make our flow behave differently between environments? It is also possible due to <em>spring:import</em> capability. Let me show you an example how we can roll it out.
Let&rsquo;s say that we are exposing a flow through a HTTP/HTTPS endpoint. For functional testing we want to use standard HTTP, but for pre-production (and production of course) we need to work with HTTPS.
To accomplish that, instead of having our endpoint &lsquo;hardcoded&rsquo; in the flow, we&rsquo;ll use flow reference:</p>
<p><img src="/images/munit/MainFlow.png" alt="MainFlow"></p>
<p>and set up spring import in the .xml config file:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;spring:beans&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;spring:import</span> <span style="color:#50fa7b">resource=</span><span style="color:#f1fa8c">&#34;classpath:my-endpoint-${connection.type}.xml&#34;</span> <span style="color:#ff79c6">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/spring:beans&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You shouldn&rsquo;t care about Studio throwing errors. It is not a rare case, that Studio is complaining about something, which is perfectly ok for Mule ESB itself.
Don&rsquo;t forget to have <strong>{connection.type}</strong> parameter set up in <strong>wrapper.conf</strong> of each of the Mule instances. Assume to expect only two possibilities here: secured / unsecured. Then we need to prepare two separate configuration files (located on the classpath): <strong>my-endpoint-secured.xml</strong> and <strong>my-endpoint-unsecured.xml</strong> and provide flow reference implementations (secured with HTTPS component, unsecured with HTTP). Remember about having same flow name as in the flow reference. After that, we&rsquo;re done. Mule instance will pick appropriate setup, basing on the <strong><em>connection.type</em></strong> parameter provided.
One last thing we would need to remember about in terms of testing such constructs. MUnit need to know which HTTP type to test with. We can provide it by adding a system property in the getConfigResources() method:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Override
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd;font-style:italic">protected</span> String <span style="color:#50fa7b">getConfigResources</span>() {
</span></span><span style="display:flex;"><span>  System.<span style="color:#50fa7b">setProperty</span>(<span style="color:#f1fa8c">&#34;connection.type&#34;</span>, <span style="color:#f1fa8c">&#34;unsecured&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;main-flow.xml&#34;</span>;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></td></tr></table>
</div>
</div><p>Of course those Strings should be extracted to constants, as you would use them a lot.</p>
<h2 id="mocking">Mocking</h2>
<p>It&rsquo;s time to talk about crucial element of flows testing. In the beginning we need to realize that every component in Mule is a message processor (endpoint, flow reference etc). That makes MUnit powerful tool, as it has the ability to mock any of such things. Lets decompose mock expression into two parts:</p>
<ul>
<li>Defining mock target</li>
</ul>
<p>You always starts your mock expression with <strong>whenMessageProcessor()</strong> fluent method. Required parameter is the processor name (XML tag name in Mule configuration file).
Then, if our processor is within a namespace we need to apply <strong>.ofNamespace()</strong> method to our mock.
Lastly, if there is more than one element with same name (i.e. flow, sub-flow, endpoints) we need to add <strong>.withAttributes()</strong> method, which takes <em>Map&lt;String,Object&gt;</em> or varargs <em>Attribute</em> as an argument. The latter is easy to create with a static helper structure available: <strong>attribute(String name).withValue(Object value)</strong></p>
<ul>
<li>Defining mock behaviour</li>
</ul>
<p>When we&rsquo;re done with target declaration we need to specify how our mock should behave. There are a couple of options here:</p>
<p><strong>.thenReturnSameEvent()</strong> - Means that message processor you mocked out will do nothing (outputs the same thing that came to the processor) during the flow processing.
<strong>.thenThrow(Throwable exception)</strong> - Mocked processor will throw specified exception.
<strong>.thenReturn(MuleMessage message)</strong> - This will return a MuleMessage object prepared beforehand. We can make use of available <strong>muleMessageWithPayload(Object payload)</strong> method to help ourselves here. Actually, I don&rsquo;t use thenReturn() method much, as it&rsquo;s not flexible enough. Especially when working with Mule properties and reusable flows.
<strong>.thenApply(MuleMessageTransformer transformer)</strong> - Most flexible method. Here we can prepare and use a Mule transformer, meaning we can do and return almost anything in our message (like quickly add properties using property enricher)</p>
<p>Example of flow mocking:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>whenMessageProcessor(<span style="color:#f1fa8c">&#34;flow&#34;</span>).<span style="color:#50fa7b">withAttributes</span>(attribute(<span style="color:#f1fa8c">&#34;name&#34;</span>).<span style="color:#50fa7b">withValue</span>(<span style="color:#f1fa8c">&#34;ValidateHTTPRequest&#34;</span>)).<span style="color:#50fa7b">thenReturnSameEvent</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><p>More examples can be seen <a href="https://github.com/mulesoft/munit/blob/munit-3.4.x/munit-integration-tests/src/test/java/org/mule/java/JavaMunitTest.java">here</a>. (note the contains() part when mocking sub-flows)</p>
<p>While it seems as a great and powerful feature, let me tell you when and why not to use mocking. Referring to our example we have a <em>MainFlow</em> which has several flow references. I want to mock out all those references, to make a simple test of the choice component, whether it routes properly (to send email or not). My first thought with that approach in mind, was to provide only <strong>main-flow.xml</strong> to my MUnit test (I want to have rest of flows mocked). Unfortunately, that&rsquo;s not possible. Mule needs to set up all flows during start up, meaning it will fail saying that flow couldn&rsquo;t be found. To overcome that, we would still need to provide all flow constructs (despite mocking), which implies greatly increased Mule start up time. (referenced flows can be complex, compound of even more flows / subflows). Not to mention configuration hassle (did I included all required flows?).
Of course we want our tests to perform as quick as possible. Solution for that is the way I was mocking flows before MUnit era. You need to create simple testing mock flows (with same flow names as in production code) and provide them in getConfigResources() method instead of the originals (<strong>src/test/resources</strong> is a great place to store them), but be careful! When you work with test flows, don&rsquo;t use Mule Config Flow Editor. Otherwise, you would end up with duplicated tests flows in <strong>src/main/app</strong> folder. There&rsquo;s a <a href="https://www.mulesoft.org/jira/browse/STUDIO-2285">JIRA ticket</a> for that. It now says it has been resolved in 3.5 Dolomite version. Not sure about the code names&hellip; but in my current Mule Studio (Version: 3.5.0 Build Id: 201402101410) it is still not working properly.</p>
<h2 id="implementing-mocked-services">Implementing mocked services</h2>
<p>It may sometimes be useful to simulate some more complex behavior of an external service in a form of a Mule mocked service implementation. We can accomplish that by combining everything we covered so far.
First thing would be to make sure that service outbound address parameters are externalized to a properties file and that property file is made environment specific (via system property - refer to earlier mentioned Confluex blog post). Then we need to code actual mock implementation in a test flow (address parameters can be any). We also need to create property file with mock service address (as it would be an another environment configuration set up).</p>
<p>To wrap everything together we need to set system property (in <strong>getConfigResources()</strong>) to a value we are using in a property file indicating mocked service address. Remember also of adding this mocked service flow to a collection of flows, which shouldn&rsquo;t have their inbound endpoints disabled. Otherwise, your mocked service won&rsquo;t be accessible at all.</p>
<p>I know that MUnit also offers FTP, Mail and DB servers that you can spawn on the fly in your tests. However, I didn&rsquo;t try them out yet, so it&rsquo;s better you check MUnit <a href="https://github.com/mulesoft/munit/wiki#integration-tests">wiki page</a> for more information on that.</p>
<h2 id="verifying--spying">Verifying &amp; spying</h2>
<p>There two other MUnit features worth mentioning:
Veryfing is a way to assert whether a message processor has been called during test execution. Its semantic is very similar to mocking. Instead of <em>whenMessageProcessor()</em> method we need to use <strong><em>verifyCallOfMessageProcessor()</em></strong> providing processor name with its identification details (if necessary: <em>ofNamespace()</em>, <em>withAttributes()</em>) and then using available assertion methods: <strong><em>.atLeastOnce()</em></strong>, .<strong><em>atLeast()</em></strong>, <em>.<strong>atMost()</strong></em>. Names are self-explanatory. With <strong><em>atLeast()</em></strong> and <em><strong>atMost()</strong></em> you need to provide integer value to make those assertions sensible.</p>
<p>Example validating that send email flow was called at least 2 times:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>verifyCallOfMessageProcessor(FLOW).<span style="color:#50fa7b">withAttributes</span>(attribute(NAME).<span style="color:#50fa7b">withValue</span>(<span style="color:#f1fa8c">&#34;SendNotificationEmail&#34;</span>)).<span style="color:#50fa7b">atLeast</span>(2);
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spying can be used to validate assumptions before any given message processor starts processing or just right after. Again you start the same as with verifying and mocking, but with <strong>spyMessageProcessor()</strong> method. When the target is acquired you can use <strong>.before()</strong> and <strong>.after()</strong> method passing any number of <strong>SpyProcess</strong> instances as an argument.
<strong>SpyProcess</strong> is an interface with one method signature: <strong>void spy(MuleEvent event)</strong>. In that method implementation you can perform your assertions and check the payload in before or after phase.</p>
<p>Example checking variable presence and value, before and after using set-variable component:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>spyMessageProcessor(<span style="color:#f1fa8c">&#34;set-variable&#34;</span>).<span style="color:#50fa7b">withAttributes</span>(attribute(<span style="color:#f1fa8c">&#34;variableName&#34;</span>).<span style="color:#50fa7b">withValue</span>(<span style="color:#f1fa8c">&#34;text&#34;</span>))
</span></span><span style="display:flex;"><span>  .<span style="color:#50fa7b">before</span>(<span style="color:#ff79c6">new</span> SpyProcess() {
</span></span><span style="display:flex;"><span>   @Override
</span></span><span style="display:flex;"><span>   <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">spy</span>(MuleEvent beforeEvent) <span style="color:#8be9fd;font-style:italic">throws</span> MuleException {
</span></span><span style="display:flex;"><span>    assertThat(beforeEvent)
</span></span><span style="display:flex;"><span>     .<span style="color:#50fa7b">hasMuleMessageWhich</span>()
</span></span><span style="display:flex;"><span>      .<span style="color:#50fa7b">hasInvocationProperty</span>(<span style="color:#f1fa8c">&#34;text&#34;</span>).<span style="color:#50fa7b">notSet</span>();
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>  .<span style="color:#50fa7b">after</span>(<span style="color:#ff79c6">new</span> SpyProcess() {
</span></span><span style="display:flex;"><span>   @Override
</span></span><span style="display:flex;"><span>   <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">spy</span>(MuleEvent afterEvent) <span style="color:#8be9fd;font-style:italic">throws</span> MuleException {
</span></span><span style="display:flex;"><span>    assertThat(afterEvent)
</span></span><span style="display:flex;"><span>     .<span style="color:#50fa7b">hasMuleMessageWhich</span>()
</span></span><span style="display:flex;"><span>      .<span style="color:#50fa7b">hasInvocationProperty</span>(<span style="color:#f1fa8c">&#34;text&#34;</span>).<span style="color:#50fa7b">withValue</span>(<span style="color:#f1fa8c">&#34;hello&#34;</span>);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>  });
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>That would be about everything I could come up with. If you have any questions, suggestions please let me know. Lastly, two &lsquo;pro&rsquo; :) tips:</p>
<ul>
<li>do not commit any .flow files (they are required for Studio only, and are being generated from corresponding .xml)</li>
<li>good log4j configuration can save you a lot of time and trouble!</li>
</ul>

    </div>
    <div class="prev-next">
      <span>
        
          <a href="https://blog.poznachowski.pl/posts/handling-groovy-scripts-in-mule-esb/">
          <i class="fas fa-long-arrow-alt-left" aria-hidden="true"></i>
            Handling Groovy scripts in Mule ESB
          </a>
        
      </span>
      <span>
        
          <a href="https://blog.poznachowski.pl/posts/how-to-make-jenkins-speak-git-flow/">
            How to make Jenkins speak Git Flow?
            <i class="fas fa-long-arrow-alt-right" aria-hidden="true"></i>
          </a>
        
      </span>
    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "itssoapsfault" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>
    <div class ="footer-mobile">
      <section class="social">
  
  <a href="https://linkedin.com/in/gpoznachowski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
  
	
	
	<a href="https://github.com/poznachowski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	

	
	<a href="https://stackoverflow.com/users/2514330" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
  
  <a href="https://twitter.com/poznachowski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
  
	
	<a href="mailto:grzegorz@poznachowski.pl" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>
<div class="copyright">
  blog.poznachowski.pl &copy; 2013 - 2023
</div>

    </div>
  </body>
</html>

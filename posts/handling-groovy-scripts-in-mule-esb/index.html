<!doctype html>
<html lang="en-us">
  <head>
    <title>Handling Groovy scripts in Mule ESB // It&#39;s SOAP&#39;s Fault...</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.80.0-DEV" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Grzegorz Poznachowski" />
    <meta name="description" content="How to handle groovy scripts in Mule ESB" />
    <script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://blog.poznachowski.pl/css/main.min.c62e1128802cf4371e6795d244a95daf966cd81fadc8210e8e81a25d21a6511c.css" />
    <link rel="stylesheet" type="text/css" href="https:////fonts.googleapis.com/css?family=Quicksand" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63324529-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Handling Groovy scripts in Mule ESB"/>
<meta name="twitter:description" content="How to handle groovy scripts in Mule ESB"/>

    <meta property="og:title" content="Handling Groovy scripts in Mule ESB" />
<meta property="og:description" content="How to handle groovy scripts in Mule ESB" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.poznachowski.pl/posts/handling-groovy-scripts-in-mule-esb/" />
<meta property="article:published_time" content="2013-11-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2013-11-03T00:00:00+00:00" />


  </head>
  <body>
    <header class="app-header">
      <div class="flex-wrapper">
        <a href="https://blog.poznachowski.pl/">
          <img class="app-header-avatar" src="/avatarGP.jpg" alt="Grzegorz Poznachowski" />
        </a>
        <div class="flex-text">
          <a href="https://blog.poznachowski.pl/">
            <h1>It&#39;s SOAP&#39;s Fault...</h1>
          </a>
          <p>My notes on coding and software development</p>
        </div>
      </div>
      <div class ="footer-desktop">
        <section class="social">
  
  <a href="https://linkedin.com/in/gpoznachowski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
  
	
	
	<a href="https://github.com/poznachowski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	

	
	<a href="https://stackoverflow.com/users/2514330" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
  
  <a href="https://twitter.com/poznachowski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
  
	
	<a href="mailto:grzegorz@poznachowski.pl" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>
<div class="copyright">
  blog.poznachowski.pl &copy; 2013 - 2021
</div>

      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Handling Groovy scripts in Mule ESB</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Nov 3, 2013
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          6 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://blog.poznachowski.pl/tags/esb/">esb</a><a class="tag" href="https://blog.poznachowski.pl/tags/testing/">testing</a><a class="tag" href="https://blog.poznachowski.pl/tags/script/">script</a><a class="tag" href="https://blog.poznachowski.pl/tags/mule/">mule</a></div></div>
    </header>
    <div class="post-content">
      <p>In my work project we had to make plenty of XML manipulations on some complex structures. As Mule supports Groovy (<a href="http://groovy.codehaus.org/Scripts+and+Classes">scripts</a>) natively, we decided to make use of Groovy&rsquo;s <a href="http://groovy.codehaus.org/Processing+XML">XMLSlurper</a>.
Two things I wanted to have covered, before I begin: How to easily handle those scripts in Mule Studio and how to unit test them.</p>
<p><strong>1. Groovy scripts in Mule Studio</strong></p>
<p>Mule, when it comes to <a href="http://www.mulesoft.org/documentation/display/current/Groovy+Component+Reference">Groovy components</a>, can embed script code inside the Mule configuration file or use an external script file. Of course, at all times, I don&rsquo;t want to clutter my Mule code with embedded scripts. The only exception I make, is when I need to do something simple and I&rsquo;m unable to use Mule Expression Language to achieve that (i.e. throwing an exception directly from flow - <a href="https://www.mulesoft.org/jira/browse/MULE-6624">JIRA</a>).</p>
<p>First thing I did was installation of Groovy plugin for the IDE. Latest Mule Studio version is 3.5.0, which is based on Eclipse 3.8. Update site URL for the plugin is: <a href="http://dist.springsource.org/release/GRECLIPSE/e4.2/">http://dist.springsource.org/release/GRECLIPSE/e4.2/</a>. My example project was built on Mule ESB 3.4.0. It uses Groovy 1.8.6, hence we have to add an extra Groovy compiler when installing plugin and we have to switch it on in Groovy preferences afterwards.</p>
<p>Next, we need to think about where to locate our scripts. There are several possibilities, but I find most convinient to put them in <strong>src/main/scripts</strong> in a subfolder named as a Mule configuration file, which uses it. Then, we need to force IDE to be as useful as possible, especially the m2e plugin built in Mule Studio. I always work on Maven-supported Mule projects and strongly recommend to do the same.</p>
<ul>
<li>Enable Groovy scripts folders in Groovy preferences and add <strong>src/main/scripts</strong> and <strong>src/test/scripts</strong> patterns (note that Compiler version is already set to 1.8.6):</li>
</ul>
<p><img src="/images/mulegroovy/groovy_settings.png" alt="groovy_settings"></p>
<ul>
<li>Now we need to make sure that Maven will put those scripts in proper location. Ideal for me, is to put them in <strong>classes/scripts</strong> directory. It will cause nice separation with other project resources. Achieving that appeared to be simple. In <strong>pom.xml</strong> specify resources in the <strong>&lt;build&gt;</strong> part:</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;build&gt;</span>
    <span style="color:#ff79c6">&lt;resources&gt;</span>
        <span style="color:#ff79c6">&lt;resource&gt;</span>
            <span style="color:#ff79c6">&lt;directory&gt;</span>src/main/resources<span style="color:#ff79c6">&lt;/directory&gt;</span>
        <span style="color:#ff79c6">&lt;/resource&gt;</span>
        <span style="color:#ff79c6">&lt;resource&gt;</span>
            <span style="color:#ff79c6">&lt;directory&gt;</span>src/main/scripts<span style="color:#ff79c6">&lt;/directory&gt;</span>
            <span style="color:#ff79c6">&lt;targetPath&gt;</span>scripts<span style="color:#ff79c6">&lt;/targetPath&gt;</span>
        <span style="color:#ff79c6">&lt;/resource&gt;</span>
    <span style="color:#ff79c6">&lt;/resources&gt;</span>
    ...
<span style="color:#ff79c6">&lt;/build&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Maven&rsquo;s build <strong>&lt;resources/&gt;</strong> element is described <a href="http://maven.apache.org/pom.html#Resources">here</a>. When doing research about the above I found out something interesting. With the default structure of pom.xml file generated by Mule Studio, all Mule configuration files are duplicated in the built zip file. Sample Mule application structure generated by Maven would look like:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"> \- classes
  \- mule-config.xml
  |- mule-deploy.properties
  |- mule-app.properties
 |- lib
 |- mule-config.xml
 |- mule-deploy.properties
 |- mule-app.properties
</code></pre></td></tr></table>
</div>
</div><p>Files (<strong>2,3,4</strong>) are redundant (per Mule&rsquo;s application format <a href="http://www.mulesoft.org/documentation/display/current/Application+Format">reference</a>). Responsible for that mess is <strong>Build Helper Maven Plugin</strong>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;plugin&gt;</span>
    <span style="color:#ff79c6">&lt;groupId&gt;</span>org.codehaus.mojo<span style="color:#ff79c6">&lt;/groupId&gt;</span>
    <span style="color:#ff79c6">&lt;artifactId&gt;</span>build-helper-maven-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
    <span style="color:#ff79c6">&lt;version&gt;</span>1.7<span style="color:#ff79c6">&lt;/version&gt;</span>
    <span style="color:#ff79c6">&lt;executions&gt;</span>
        <span style="color:#ff79c6">&lt;execution&gt;</span>
            <span style="color:#ff79c6">&lt;id&gt;</span>add-resource<span style="color:#ff79c6">&lt;/id&gt;</span>
            <span style="color:#ff79c6">&lt;phase&gt;</span>generate-resources<span style="color:#ff79c6">&lt;/phase&gt;</span>
            <span style="color:#ff79c6">&lt;goals&gt;</span>
                <span style="color:#ff79c6">&lt;goal&gt;</span>add-resource<span style="color:#ff79c6">&lt;/goal&gt;</span>
            <span style="color:#ff79c6">&lt;/goals&gt;</span>
            <span style="color:#ff79c6">&lt;configuration&gt;</span>
                <span style="color:#ff79c6">&lt;resources&gt;</span>
                    <span style="color:#ff79c6">&lt;resource&gt;</span>
                        <span style="color:#ff79c6">&lt;directory&gt;</span>src/main/app/<span style="color:#ff79c6">&lt;/directory&gt;</span>
                    <span style="color:#ff79c6">&lt;/resource&gt;</span>
                <span style="color:#ff79c6">&lt;/resources&gt;</span>
            <span style="color:#ff79c6">&lt;/configuration&gt;</span>
        <span style="color:#ff79c6">&lt;/execution&gt;</span>
    <span style="color:#ff79c6">&lt;/executions&gt;</span>
<span style="color:#ff79c6">&lt;/plugin&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>If I remove that plugin part, everything still seems to be working perfectly fine and my project&rsquo;s output structure is neat and clean:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"> \- classes
  \- scripts
   \- GroovyScriptTesting
    \- CalculateSquareNumber.groovy
  |- log4j.properties
 |- GroovyScriptTesting.xml
 |- mule-deploy.properties
 |- mule-app.properties
</code></pre></td></tr></table>
</div>
</div><p>It looks like <strong>maven-mule-plugin</strong> is doing all the necessary work for <strong>src/main/app</strong> folder. So, if you know why the build helper plugin is set up in the pom.xml in the first place or if you&rsquo;re having any problem without it, please let me know.
In the end, with everything in place, my project in Mule Studio should look like this:</p>
<p><img src="/images/mulegroovy/groovy_project_setup.png" alt="groovy_project_setup"></p>
<p>and we are ready to go to the second part.</p>
<p><strong>2. Unit testing Groovy scripts</strong></p>
<p>Mule provide direct access to Mule context objects and variables in Groovy scripts the same way as it does for MEL. In terms of testing, it&rsquo;s important to decide and be consequent about how we are accessing Mule variables:
If I&rsquo;m sure that the variable will be defined during script execution, I access them directly (as &lsquo;number&rsquo; in the example):</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#8be9fd">def</span> square <span style="color:#ff79c6">=</span> number<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toInteger</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">*</span> number<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toInteger</span><span style="color:#ff79c6">()</span>
</code></pre></td></tr></table>
</div>
</div><p>If it&rsquo;s possible that the variable won&rsquo;t be set up (can be a part of the script logic - to check for variable presence), then I would try to get it from the message context (it&rsquo;s always available):</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#8be9fd">def</span> number <span style="color:#ff79c6">=</span> message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInvocationProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#39;number&#39;</span><span style="color:#ff79c6">)</span>
</code></pre></td></tr></table>
</div>
</div><p>and then do some null checks etc. Otherwise, I would get Groovy&rsquo;s <strong>MissingPropertyException</strong>.
Setting variables via scripts always needs to happen using message.setProperty method.</p>
<p>Let&rsquo;s look at this simple Groovy script (<strong>CalculateSquareNumber.groovy</strong>):</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#8be9fd">def</span> square <span style="color:#ff79c6">=</span> number<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toInteger</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">*</span> number<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toInteger</span><span style="color:#ff79c6">()</span>
message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setInvocationProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#39;squareNumber&#39;</span><span style="color:#ff79c6">,</span> square<span style="color:#ff79c6">)</span>
</code></pre></td></tr></table>
</div>
</div><p>and it&rsquo;s unit test (<strong>CalculateSquareNumberTest.java</strong>):</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@RunWith<span style="color:#ff79c6">(</span>JUnitParamsRunner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CalculateSquareNumberTest</span> <span style="color:#ff79c6">{</span>

	<span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String PAYLOAD <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;payload&#34;</span><span style="color:#ff79c6">;</span>

	@Test
	@Parameters<span style="color:#ff79c6">(</span>method <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;numbersAndSquares&#34;</span><span style="color:#ff79c6">)</span>
	<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> number<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> square<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>

		Binding binding <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Binding<span style="color:#ff79c6">();</span>
		binding<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setVariable</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;number&#34;</span><span style="color:#ff79c6">,</span> number<span style="color:#ff79c6">);</span>
		binding<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setVariable</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;message&#34;</span><span style="color:#ff79c6">,</span> TestMuleMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">withPayload</span><span style="color:#ff79c6">(</span>PAYLOAD<span style="color:#ff79c6">));</span>

		GroovyShell shell <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> GroovyShell<span style="color:#ff79c6">(</span>binding<span style="color:#ff79c6">);</span>
		shell<span style="color:#ff79c6">.</span><span style="color:#50fa7b">evaluate</span><span style="color:#ff79c6">(</span>getFile<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/scripts/GroovyScriptTesting/CalculateSquareNumber.groovy&#34;</span><span style="color:#ff79c6">));</span>
		MuleMessage message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>MuleMessage<span style="color:#ff79c6">)</span> binding<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getVariable</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;message&#34;</span><span style="color:#ff79c6">);</span>

		assertThat<span style="color:#ff79c6">((</span>Integer<span style="color:#ff79c6">)</span>message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInvocationProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;squareNumber&#34;</span><span style="color:#ff79c6">),</span> is<span style="color:#ff79c6">(</span>square<span style="color:#ff79c6">));</span>
	<span style="color:#ff79c6">}</span>

	@SuppressWarnings<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;unused&#34;</span><span style="color:#ff79c6">)</span>
	<span style="color:#8be9fd;font-style:italic">private</span> Object<span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">numbersAndSquares</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
		<span style="color:#ff79c6">return</span> $<span style="color:#ff79c6">(</span>
             $<span style="color:#ff79c6">(</span>3<span style="color:#ff79c6">,</span> 9<span style="color:#ff79c6">),</span>
             $<span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">,</span> 25<span style="color:#ff79c6">),</span>
             $<span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">,</span> 100<span style="color:#ff79c6">),</span>
             $<span style="color:#ff79c6">(</span>12<span style="color:#ff79c6">,</span> 144<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">);</span>
	<span style="color:#ff79c6">}</span>

	<span style="color:#8be9fd;font-style:italic">private</span> File <span style="color:#50fa7b">getFile</span><span style="color:#ff79c6">(</span>String pathToFile<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> URISyntaxException<span style="color:#ff79c6">,</span> FileNotFoundException <span style="color:#ff79c6">{</span>
		URL url <span style="color:#ff79c6">=</span> CalculateSquareNumberTest<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getResource</span><span style="color:#ff79c6">(</span>pathToFile<span style="color:#ff79c6">);</span>
		<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>url <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
			<span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> FileNotFoundException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Couldn&#39;t find: &#34;</span> <span style="color:#ff79c6">+</span> pathToFile<span style="color:#ff79c6">);</span>
		<span style="color:#ff79c6">}</span>
		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> File<span style="color:#ff79c6">(</span>url<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toURI</span><span style="color:#ff79c6">());</span>
	<span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>To evaluate Groovy scripts in our test we need to use <a href="http://groovy.codehaus.org/api/groovy/lang/GroovyShell.html">GroovyShell</a> along with <a href="http://groovy.codehaus.org/api/groovy/lang/Binding.html">Binding</a>&rsquo;s setVariable() method to make variables available. As you can see it&rsquo;s pretty easy, the trickier part is how to pass proper MuleMessage instance to our test. To do that, I have prepared helper <strong>TestMuleMessage</strong> class, which is preparing message with default Mule context:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">TestMuleMessage</span> <span style="color:#ff79c6">{</span>

	<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> MuleMessage <span style="color:#50fa7b">withPayload</span><span style="color:#ff79c6">(</span>Object payload<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>

		MuleContextFactory contextFactory <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultMuleContextFactory<span style="color:#ff79c6">();</span>
		MuleContext muleContext <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
		<span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
			muleContext <span style="color:#ff79c6">=</span> contextFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createMuleContext</span><span style="color:#ff79c6">();</span>
		<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InitialisationException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
			e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
		<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>ConfigurationException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
			e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
		<span style="color:#ff79c6">}</span>

		<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> DefaultMuleMessage<span style="color:#ff79c6">(</span>payload<span style="color:#ff79c6">,</span> muleContext<span style="color:#ff79c6">);</span>
	<span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Another useful thing in the test is the helper <strong>getFile()</strong> method which retrieves script file not from hardcoded full path, but from classpath instead, which is always a better idea. Usually, you would put it in some test util class.
Your main target for assertions is <strong>MuleMessage</strong> object, which can be retrieved using Binding <strong>getVariable</strong>() method. There you can check for variables' values or message payload itself.
As you can see, keeping few simple rules, can make work with Groovy scripts (in Mule) a pleasant, easily testable experience. Sample project, I prepared, is using Quartz endpoint and Groovy script to count and display square number of number 5 :) It is available <a href="https://github.com/poznachowski/GroovyScriptTesting">here</a>.</p>

    </div>
    <div class="prev-next">
      <span>
        
          <a href="https://blog.poznachowski.pl/posts/exposing-restful-interface-with-mule-pt2/">
          <i class="fas fa-long-arrow-alt-left" aria-hidden="true"></i>
            Exposing RESTful interface with Mule pt.2
          </a>
        
      </span>
      <span>
        
          <a href="https://blog.poznachowski.pl/posts/munit-testing-mule-practices-and-some/">
            MUnit testing, Mule best practices and more...
            <i class="fas fa-long-arrow-alt-right" aria-hidden="true"></i>
          </a>
        
      </span>
    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "itssoapsfault" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>
    <div class ="footer-mobile">
      <section class="social">
  
  <a href="https://linkedin.com/in/gpoznachowski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
  
	
	
	<a href="https://github.com/poznachowski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	

	
	<a href="https://stackoverflow.com/users/2514330" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
  
  <a href="https://twitter.com/poznachowski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
  
	
	<a href="mailto:grzegorz@poznachowski.pl" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>
<div class="copyright">
  blog.poznachowski.pl &copy; 2013 - 2021
</div>

    </div>
  </body>
</html>

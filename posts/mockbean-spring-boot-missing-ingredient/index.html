<!doctype html>
<html lang="en-us">
  <head>
    <title>@MockBean - Spring Boot&#39;s missing ingredient // It&#39;s SOAP&#39;s Fault...</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.120.3">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Grzegorz Poznachowski" />
    <meta name="description" content="Testing with Spring Boot&#39;s @MockBean annotation" />
    <script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://blog.poznachowski.pl/css/main.min.d2628e6ba0d9f16b8d64c2324354aac3b4b6815035d0bd0606508586eca3ccf3.css" />
    <link rel="stylesheet" type="text/css" href="https:////fonts.googleapis.com/css?family=Quicksand" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63324529-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="@MockBean - Spring Boot&#39;s missing ingredient"/>
<meta name="twitter:description" content="Testing with Spring Boot&#39;s @MockBean annotation"/>
<meta name="twitter:site" content="@poznachowski"/>

    <meta property="og:title" content="@MockBean - Spring Boot&#39;s missing ingredient" />
<meta property="og:description" content="Testing with Spring Boot&#39;s @MockBean annotation" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.poznachowski.pl/posts/mockbean-spring-boot-missing-ingredient/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-06-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2016-06-15T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <div class="flex-wrapper">
        <a href="https://blog.poznachowski.pl/">
          <img class="app-header-avatar" src="/gp.jpg" alt="Grzegorz Poznachowski" />
        </a>
        <div class="flex-text">
          <a href="https://blog.poznachowski.pl/">
            <h1>It&#39;s SOAP&#39;s Fault...</h1>
          </a>
          <p>My notes on coding and software development</p>
        </div>
      </div>
      <div class ="footer-desktop">
        <section class="social">
  
  <a href="https://linkedin.com/in/gpoznachowski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
  
	
	
	<a href="https://github.com/poznachowski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	

	
	<a href="https://stackoverflow.com/users/2514330" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
  
  <a href="https://twitter.com/poznachowski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
  
	
	<a href="mailto:grzegorz@poznachowski.pl" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>
<div class="copyright">
  blog.poznachowski.pl &copy; 2013 - 2023
</div>

      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">@MockBean - Spring Boot&#39;s missing ingredient</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          15.06.2016
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          10 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://blog.poznachowski.pl/tags/spring-boot/">spring-boot</a><a class="tag" href="https://blog.poznachowski.pl/tags/testing/">testing</a><a class="tag" href="https://blog.poznachowski.pl/tags/mock/">mock</a><a class="tag" href="https://blog.poznachowski.pl/tags/jsr-310/">jsr-310</a></div></div>
    </header>
    <div class="post-content">
      <div class="paragraph">
<p>I really liked the Spring Boot’s concept, since I first saw it.
The only thing, I felt, it was missing was a better support for testing in general.</p>
</div>
<div class="sect2">
<h3 id="_the_problem">The problem</h3>
<div class="paragraph">
<p>It all started, when I wanted to have a way to test &#39;current date&#39; logic in my application.
It was supposed to be a reusable, easy-to-use feature (via an annotation) in a custom Spring Boot Starter.
The starter is based on Java 8, hence JSR-310 Date / Time API is a natural pick.
Current date is only one of several things I want to make &#34;mockable&#34; in integration tests.
There are other areas of functionality that are good candidates for mocking out.
Keeping that in mind, I will use <code>ZonedDateTime</code> class as a mocking example across the article.</p>
</div>
</div>
<div class="sect2">
<h3 id="_serving_current_date_in_jsr_310">Serving current date in JSR-310</h3>
<div class="paragraph">
<p>Java 8 comes with new, redesigned API for handling Date and Time.
It is designed after <strong>Joda-Time</strong>, but with many improvements and changes.
Here is a nice <a href="http://stackoverflow.com/questions/24631909/differences-between-java-8-date-time-api-java-time-and-joda-time">StackOverflow post</a>
pointing out most important ones.
One of nice features Joda-Time has, is <code>DateTimeUtils.setCurrentMillisFixed(long fixedMillis)</code>.
With that method I was able to set fixed current time easily and reset to system time by invoking <code>DateTimeUtils.setCurrentMillisSystem()</code>
after test execution.
However, it did not make through to Java 8 API.
Probably, due to the fact, that Joda-Time implementation of the functionality was kind of hackish.
Shared, static variable is used there for keeping <code>MillisProvider</code> instance.</p>
</div>
<div class="paragraph">
<p>How to achieve the same with JSR-310?
Most easy and basic way is to invoke <code>ZonedDateTime.now()</code>.
However, it would be bad from testing perspective.
How would you test that?
There are two more overloaded <code>now</code> methods and we are mostly interested in <code>now(Clock clock)</code>.
It’s Javadoc confirms that we are in the right place:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Obtains the current date-time from the specified clock.</p>
</div>
<div class="paragraph">
<p>This will query the specified clock to obtain the current date-time.<br/>
The zone and offset will be set based on the time-zone in the clock.</p>
</div>
<div class="paragraph">
<p><strong>Using this method allows the use of an alternate clock for testing.<br/>
The alternate clock may be introduced using dependency injection.</strong></p>
</div>
<div class="paragraph">
<p>@param clock  the clock to use, not null<br/>
@return the current date-time, not null</p>
</div>
</blockquote>
<div class="attribution">
— ZonedDateTime.now(Clock clock) Javadoc
</div>
</div>
<div class="paragraph">
<p>Ok, so now we need <code>Clock</code> instance to pass in.
How to get it?
Second part of the Javadoc highlighted text has the answer.
Treat it as a normal dependency and use dependency injection for that.
Hence, the easiest way is to declare a <code>Clock</code> bean in your application:</p>
</div>
<div class="listingblock">
<div class="title">Specyfing Clock bean</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Clock</span> <span class="nf">clock</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Clock</span><span class="o">.</span><span class="na">systemDefaultZone</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and use it as a regular dependency.</p>
</div>
<div class="paragraph">


<aside class="admonition">
  <div class="admonition-bar tip">
    <i class="fas
    
    fa-lightbulb
    

"></i>
  </div>
  <div class="admonition-content tip"><div class="paragraph">
<p>Since <a href="https://spring.io/blog/2016/03/04/core-container-refinements-in-spring-framework-4-3">Spring 4.3.RC1</a> you don’t need
to put <code>@Autowired</code> annotation with a single constructor class.
So, if you use <a href="https://projectlombok.org/">Lombok</a> and constructor injection (you always should!), you can reduce your initial code to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Service</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClockService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Clock</span> <span class="n">clock</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Boot supports this since <a href="https://github.com/spring-projects/spring-boot/issues/5616">1.4.0.M2</a>.</p>
</div>
</div>
</aside>

</div>
</div>
<div class="sect2">
<h3 id="_before_spring_boot_1_4_0_m2">Before Spring Boot 1.4.0.M2</h3>
<div class="paragraph">
<p>It’s time for the main course.
How we are going to test current date backed up with injected <code>Clock</code>?</p>
</div>
<div class="paragraph">
<p>The simplest solution I thought about was to use <code>@Primary</code>:</p>
</div>
<div class="listingblock">
<div class="title">Specifying primary bean</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Bean</span>
<span class="nd">@Primary</span>
<span class="kd">public</span> <span class="nc">Clock</span> <span class="nf">clock</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Clock</span><span class="o">.</span><span class="na">fixed</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&#34;2010-01-10T10:00:00Z&#34;</span><span class="o">),</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;UTC&#34;</span><span class="o">));</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Primary beans are always prefered and picked in a situation where 2 or more beans of the same type are found.
It works just fine for a single test case, but if you wanted to reuse it among your test classes,
you would need to copy this definition over and over.
One can extract it to a super class and use inheritance.
I find such solution a design smell.
If there are more candidates to mock, several artificial classes has to be created along with an inheritance tree, which would
obscure the test code.</p>
</div>
<div class="paragraph">
<p>As stated before, the solution is going to be a part of a custom Spring Boot starter.
Because of that, I was determined to make <code>Clock</code> mocking mechanism annotation based.
My first idea was to use <code>@ContextConfiguration</code> in my custom annotations, which would call configuration
of mocked <code>Clock</code> with <code>@Primary</code>.
After few attempts my lack of Spring knowledge came out.
Fortunately, Sam Brannen answered my question and <a href="http://stackoverflow.com/questions/35733344/can-contextconfiguration-in-a-custom-annotation-be-merged">explained it nicely</a>.
Next approach was to incorporate Spring profiles.
In my test starter I have added profile specific configuration with <code>@Primary</code> mocked out bean dependencies.</p>
</div>
<div class="listingblock">
<div class="title">Profile specific auto-configuration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Profile</span><span class="o">(</span><span class="s">&#34;fixedClock&#34;</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FixedClockAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use them I had to run my integration tests with corresponding profiles via <code>@ActiveProfiles</code>.
There were two major drawbacks I didn’t like with the solution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Active profiles names had to be provided explicitly, that would mean remembering all available profile names.</p>
</li>
<li>
<p>Mocked clock has some default value. I wanted to provide an option to override this value.
That was possible via <code>@TestPropertySource</code>, but again, property name had to be remembered.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Was there anything else I could do, but I’m just not aware of?
Eventually, Phil Webb <a href="http://stackoverflow.com/questions/35848467/spring-boot-integration-test-doubles-by-annotations">clarified that Spring Boot 1.3 does not have the tools</a> I’m looking for.
With the bad news he brought, he brought also hope…​
Spring Boot 1.4 is supposed to bring heavy testing enhancements.
Simplified annotation naming, focused testing (on JSON, MVC or JPA slices) and desired mocking support.</p>
</div>
<div class="paragraph">
<p>I had to wait…​ and for the time being, I did a slight improvement over my profiles.
I created a simple implementation of <code>ActiveProfilesResolver</code>, which enables picking proper profile via an annotation:</p>
</div>
<div class="listingblock">
<div class="title">Example active profile resolver</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestProfilesResolver</span> <span class="kd">implements</span> <span class="nc">ActiveProfilesResolver</span> <span class="o">{</span>

    <span class="nc">ImmutableMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="no">PROFILES</span> <span class="o">=</span> <span class="nc">ImmutableMap</span><span class="o">.&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;,</span> <span class="nc">String</span><span class="o">&gt;</span><span class="n">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Wiremock</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;wireMock&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">FixedClock</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;fixedClock&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">resolve</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">testClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">profiles</span> <span class="o">=</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>
        <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">testClass</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">()).</span><span class="na">forEach</span><span class="o">(</span><span class="n">annotation</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotationType</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">annotationType</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">PROFILES</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">annotationType</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">profiles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="no">PROFILES</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">annotationType</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">profiles</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">profiles</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use it, annotate your integration test with <code>@ActiveProfiles(resolver = TestProfilesResolver.class)</code>.</p>
</div>
<div class="paragraph">
<p>It worked, but it had to be a part of the application and not a part of the starters I was preparing.
Reason for that are mock candidates - located in many different starters.
Without hardcoding all of them in a single one, it wouldn’t be particularly easy to accomplish.</p>
</div>
</div>
<div class="sect2">
<h3 id="_do_it_like_a_boss">Do it like a boss</h3>
<div class="paragraph">
<p>Ok, so all <a href="https://spring.io/blog/2016/04/15/testing-improvements-in-spring-boot-1-4">the goodies are in place</a> - Spring Boot 1.4.0.M2 is out for some time now.
Mockito support included.
All tutorials and
<a href="http://docs.spring.io/spring-boot/docs/1.4.0.M2/reference/htmlsingle/#boot-features-testing-spring-boot-applications-mocking-beans">documentation</a>
shows, however, only the basic usage of
<code><a href="https://github.com/spring-projects/spring-boot/blob/c167e4fd0e834dedf0fd3c55a026e5671c6f4e7f/spring-boot-test/src/main/java/org/springframework/boot/test/mock/mockito/MockBean.java">@MockBean</a></code>
annotation.
Which is specifying the annotation on a class field and using Mockito methods directly in the test class:</p>
</div>
<div class="listingblock">
<div class="title">Example @MockBean usage</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MockBeanIntegrationTest</span> <span class="o">{</span>

    <span class="nd">@MockBean</span>
    <span class="kd">private</span> <span class="nc">SomeService</span> <span class="n">someService</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setupMock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">when</span><span class="o">(</span><span class="n">someService</span><span class="o">.</span><span class="na">getResult</span><span class="o">())</span>
            <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&#34;success&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this in place, <code>SomeService</code> dependency is mocked out and set up to return &#34;success&#34; String anytime <code>getResult()</code> is invoked.
Mocks are reset after each test method by default.
There is also analogical support for spying beans via <code>@SpyBean</code> annotation.
It all works great, but there is more to that!</p>
</div>
<div class="paragraph">
<p><code>@MockBean</code>, implemented as meta-annotation, combined with <code>TestExecutionListener</code> is something I was looking for the whole time.
The idea is simple - create annotation that would indicate mocking particular dependency and handle mocking internals in the execution
listener:</p>
</div>
<div class="paragraph">
<p>First thing we can do is define our annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@Documented</span>
<span class="nd">@Inherited</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@MockBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">Clock</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">reset</span> <span class="o">=</span> <span class="nc">MockReset</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">FixedClock</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">&#34;2010-01-10T10:00:00Z&#34;</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the only interesting part here.
Anytime you annotate your test with <code>@FixedClock</code>, it substitutes application context’s Clock-type bean with a mock.
We are disabling mock reset deliberately - it will be handled by the <code>TestExecutionListener</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><code><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/TestExecutionListener.java">TestExecutionListener</a></code>
is a feature in spring-test component, that allows to plug &#39;Spring context&#39;-aware custom code in JUnit test lifecycle phases.
As explained in <a href="http://docs.spring.io/spring/docs/4.3.0.RELEASE/spring-framework-reference/htmlsingle/#testcontext-tel-config">documentation</a>,
there are couple of default listeners registered.
You can use your own by using <code>@TestExecutionListeners</code> annotation on a given test, but a better way is to
register it automatically via <code>META-INF/spring.factories</code> properties
(under <code>org.springframework.test.context.TestExecutionListener</code> key).
If order of your listeners is important you can easily assign the order value by implementing <code>Ordered</code> or by
annotating your listener with <code>@Order</code>.</p>
</div>
<div class="paragraph">
<p>TestExecutionListener interface has couple of methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TestExecutionListener</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">beforeTestClass</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">prepareTestInstance</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">beforeTestMethod</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">afterTestMethod</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">afterTestClass</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">


<aside class="admonition">
  <div class="admonition-bar tip">
    <i class="fas
    
    fa-lightbulb
    

"></i>
  </div>
  <div class="admonition-content tip"><div class="paragraph">
<p>If you don’t want to implement all of them, you can help yourself with <code><a href="https://github.com/spring-projects/spring-framework/blob/master/spring-test/src/main/java/org/springframework/test/context/support/AbstractTestExecutionListener.java">AbstractTestExecutionListener</a></code> class,
which provides empty method stubs.</p>
</div>
</div>
</aside>

</div>
<div class="paragraph">
<p>Let’s see how our <code>FixedClockListener</code> can implement these methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FixedClockListener</span> <span class="kd">extends</span> <span class="nc">AbstractTestExecutionListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeTestClass</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">FixedClock</span> <span class="n">classFixedClock</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">.</span><span class="na">getTestClass</span><span class="o">(),</span> <span class="nc">FixedClock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">if</span> <span class="o">(</span><span class="n">classFixedClock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">mockClock</span><span class="o">(</span><span class="n">testContext</span><span class="o">,</span> <span class="n">classFixedClock</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeTestMethod</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">FixedClock</span> <span class="n">methodFixedClock</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">.</span><span class="na">getTestMethod</span><span class="o">(),</span> <span class="nc">FixedClock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="k">if</span> <span class="o">(</span><span class="n">methodFixedClock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">verifyClassAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">);</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="n">mockClock</span><span class="o">(</span><span class="n">testContext</span><span class="o">,</span> <span class="n">methodFixedClock</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterTestMethod</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">FixedClock</span> <span class="n">methodFixedClock</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">.</span><span class="na">getTestMethod</span><span class="o">(),</span> <span class="nc">FixedClock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">methodFixedClock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">verifyClassAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">);</span>

        <span class="nc">FixedClock</span> <span class="n">classFixedClock</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">.</span><span class="na">getTestClass</span><span class="o">(),</span> <span class="nc">FixedClock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <i class="conum" data-value="8"></i><b>(8)</b>
        <span class="n">mockClock</span><span class="o">(</span><span class="n">testContext</span><span class="o">,</span> <span class="n">classFixedClock</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterTestClass</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">FixedClock</span> <span class="n">annotation</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">.</span><span class="na">getTestClass</span><span class="o">(),</span> <span class="nc">FixedClock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">reset</span><span class="o">(</span><span class="n">testContext</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Clock</span><span class="o">.</span><span class="na">class</span><span class="o">));</span> <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">verifyClassAnnotation</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FixedClock</span> <span class="n">classAnnotation</span> <span class="o">=</span> <span class="nc">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">testContext</span><span class="o">.</span><span class="na">getTestClass</span><span class="o">(),</span> <span class="nc">FixedClock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">classAnnotation</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&#34;@FixedClock class level annotation is missing.&#34;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">mockClock</span><span class="o">(</span><span class="nc">TestContext</span> <span class="n">testContext</span><span class="o">,</span> <span class="nc">FixedClock</span> <span class="n">fixedClock</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Instant</span> <span class="n">instant</span> <span class="o">=</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">fixedClock</span><span class="o">.</span><span class="na">value</span><span class="o">());</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="nc">Clock</span> <span class="n">mockedClock</span> <span class="o">=</span> <span class="n">testContext</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Clock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="n">when</span><span class="o">(</span><span class="n">mockedClock</span><span class="o">.</span><span class="na">instant</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">instant</span><span class="o">);</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="n">when</span><span class="o">(</span><span class="n">mockedClock</span><span class="o">.</span><span class="na">getZone</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">TimeZone</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">toZoneId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Simple check if a test class is annotated with our annotation. If not - skip further processing.
Prefer <code>AnnotationUtils.findAnnotation()</code> over simple <code>testClass().getAnnotations()</code> if you want to allow your annotation
to be a part of different, composed annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extracted method for setting up our mock.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieved <code>Instant</code> object out of our annotation.
Will be used as a mock stub value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>Clock</code> bean is mocked by <code>@FixedClock</code> annotation and here we are fetching the mock from the application context,
so we can provide mocking stubs on the mock instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here we provide the stubs. As they has to be declared on method calls, we cannot simply just declare <code>Clock.fixed()</code> here.
Fortunately, there are only two methods to stub: <code>instant()</code>, and <code>getZone()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>With test execution listener approach, we can handle overriden fixed Clock values per test method.
Here again, a simple check if the method is in fact annotated.
If not - skip processing.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>For test methods, we need to implement additional verification step.
We need to check if the test class was annotated as well. <code>@MockBean</code> will work only if test class was marked with it.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>After test method execution, revert mock stub to what was specified globally (per test class).</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Eventually, when all tests ran, reset the mock.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>With all we did so far, we can easily test code below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RestController</span><span class="o">(</span><span class="s">&#34;/api/time&#34;</span><span class="o">)</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimeEndpoint</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Clock</span> <span class="n">clock</span><span class="o">;</span>

    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="nc">ZonedDateTime</span> <span class="nf">getTime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ZonedDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">(</span><span class="n">clock</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and provide fixed current time in integration test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">RANDOM_PORT</span><span class="o">)</span>
<span class="nd">@FixedClock</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FixedClockTest</span> <span class="o">{</span>

    <span class="nd">@LocalServerPort</span>
    <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">RestAssured</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">port</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">get</span><span class="o">(</span><span class="s">&#34;/api/time&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">then</span><span class="o">()</span>
            <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">containsString</span><span class="o">(</span><span class="s">&#34;2010-01-10T10:00:00Z&#34;</span><span class="o">));</span> <span class="c1">// default @FixedClock value</span>

    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="nd">@FixedClock</span><span class="o">(</span><span class="s">&#34;2011-11-11T11:00:00Z&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClockOverridden</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">get</span><span class="o">(</span><span class="s">&#34;/api/time&#34;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">then</span><span class="o">()</span>
            <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">containsString</span><span class="o">(</span><span class="s">&#34;2011-11-11T11:00:00Z&#34;</span><span class="o">));</span>

    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="paragraph">
<p>At last, it seems, that Spring Boot with 1.4.0.M2 release, received last, missing piece in its testing toolbox.<br/>
Proposed solution will not only suit in a custom starter (but it’s a great fit).
You can implement similar solution in the actual application and you don’t have to limit yourself to mocking current date.
This approach let you mock anything you find appropriate, keeping your tests clean.</p>
</div>
<div class="paragraph">


<aside class="admonition">
  <div class="admonition-bar info">
    <i class="fas
    
    fa-info
    

"></i>
  </div>
  <div class="admonition-content info"><div class="paragraph">
<p>Presented code samples are part of <a href="https://github.com/neoteric-eu/neo-starters">Neo-Starters</a> - even more opinionated way of developing REST services :)</p>
</div>
</div>
</aside>

</div>
</div>

    </div>
    <div class="prev-next">
      <span>
        
          <a href="https://blog.poznachowski.pl/posts/get-along-with-your-spring-boot-starter/">
          <i class="fas fa-long-arrow-alt-left" aria-hidden="true"></i>
            Get along with your Spring Boot Starter
          </a>
        
      </span>
      <span>
        
          <a href="https://blog.poznachowski.pl/posts/developing-with-gcp-pub-sub/">
            Local development with GCP Pub/Sub and Spring Cloud Stream
            <i class="fas fa-long-arrow-alt-right" aria-hidden="true"></i>
          </a>
        
      </span>
    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "itssoapsfault" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>
    <div class ="footer-mobile">
      <section class="social">
  
  <a href="https://linkedin.com/in/gpoznachowski" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
  
	
	
	<a href="https://github.com/poznachowski" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	

	
	<a href="https://stackoverflow.com/users/2514330" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
  
  <a href="https://twitter.com/poznachowski" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
  
	
	<a href="mailto:grzegorz@poznachowski.pl" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>
<div class="copyright">
  blog.poznachowski.pl &copy; 2013 - 2023
</div>

    </div>
  </body>
</html>
